const canvas = document.getElementById('moba-map');
const ctx = canvas.getContext('2d');


// --- GAME STATE ---
const gameState = {
    influencePoints: {
        blue: 0,
        red: 0,
        target: 1000
    },
    zones: [
        // x, y are center coordinates; ipRate is IP per second when controlled
        { id: 'dockyards', x: 200, y: 100, size: 40, owner: 'neutral', ipRate: 5 },
        { id: 'numbers', x: 400, y: 300, size: 60, owner: 'neutral', ipRate: 8 },
        { id: 'official', x: 600, y: 500, size: 40, owner: 'neutral', ipRate: 5 },
        // Add Capo zones/locations here
    ],
    winCheckInterval: 2, // Check for win condition every 2 seconds
    heroes: {
        // Sample hero stats/abilities for the current player
        'Tony Soprano': {
            q: "The Quick Hook (30 WP)",
            w: "Stare Down (50 WP)",
            e: "Unload the Carcass (Passive/Toggle)",
            r_ultimate: "The Temper (Taunt/DR)"
        },
        // ... (Define all 10 heroes' ability names here for UI updates) ...
    }
};


// --- PLAYER STATE (CURRENT HERO) ---
let player = {
    name: 'Tony Soprano', // Current selected hero
    x: 100,
    y: 500,
    level: 1,
    xp: 0,
    cash: 500,
    
    // Resource Stats
    willpower: 100,
    maxWillpower: 100,
    heat: 0,
    maxHeat: 100,
    
    // Status Flags
    isRaging: false,
    rageDuration: 10, 
    rageTimer: 0,
    isGuarding: false,
    
    color: '#3498db' // Blue team
};


// --- RESOURCE AND ULTIMATE MECHANICS ---


function updateResources(delta) {
    // 1. Willpower Regeneration
    if (player.willpower < player.maxWillpower) {
        player.willpower += 3 * delta; // Faster regeneration for testing
        if (player.willpower > player.maxWillpower) {
            player.willpower = player.maxWillpower;
        }
    }
    
    // 2. Rage/The Family's Respect Timer
    if (player.isRaging) {
        player.rageTimer -= delta;
        if (player.rageTimer <= 0) {
            deactivateRage();
        }
    }


    // 3. Check if Rage is ready
    if (player.heat >= player.maxHeat) {
        document.getElementById('rage-button').classList.add('ready');
        document.getElementById('rage-button').disabled = false;
    } else {
        document.getElementById('rage-button').classList.remove('ready');
        if (!player.isRaging) document.getElementById('rage-button').disabled = true;
    }
    
    // Update the UI bars
    document.getElementById('willpower-bar').style.width = `${(player.willpower / player.maxWillpower) * 100}%`;
    document.getElementById('heat-bar').style.width = `${(player.heat / player.maxHeat) * 100}%`;
    document.getElementById('cash').textContent = `$${player.cash}`;
    document.getElementById('level').textContent = player.level;
}


function activateRage() {
    if (player.heat >= player.maxHeat && !player.isRaging) {
        player.isRaging = true;
        player.heat = 0;
        player.rageTimer = player.rageDuration;
        canvas.classList.add('raging');
        document.getElementById('ability-r').disabled = false; // Unlock BADA BING!
        console.log("🔥 THE FAMILY'S RESPECT ACTIVATED! ULTIMATE UNLOCKED!");
        document.getElementById('rage-button').disabled = true;
    }
}


function deactivateRage() {
    player.isRaging = false;
    canvas.classList.remove('raging');
    document.getElementById('ability-r').disabled = true;
    console.log("The Family's Respect has worn off.");
}


function gainHeat(amount) {
    player.heat += amount;
    if (player.heat > player.maxHeat) player.heat = player.maxHeat;
}


function gainCash(amount) {
    player.cash += amount;
}


// --- ABILITY LOGIC (The Jabs/Hits) ---


function useAbility(abilityKey) {
    const cost = 25; 


    if (abilityKey === 'Q' && player.willpower >= cost) {
        player.willpower -= cost;
        gainHeat(10); // Gain heat upon using an ability
        console.log("Using Quick Jab (Q).");
        // *** ADD HERO-SPECIFIC LOGIC HERE ***
    } else if (abilityKey === 'R' && player.isRaging) {
        console.log("💥 BADA BING! ULTIMATE ACTIVATED!");
        deactivateRage(); // Ultimate ends the rage mode
        // *** ADD HERO-SPECIFIC ULTIMATE LOGIC HERE ***
    } else {
        console.log("Not enough Willpower or ability is locked.");
    }
}


// --- OBJECTIVE AND WIN CONDITION ---


function updateScoreboard() {
    document.getElementById('blue-score').textContent = `Blue Crew IP: ${Math.floor(gameState.influencePoints.blue)}`;
    document.getElementById('red-score').textContent = `Red Crew IP: ${Math.floor(gameState.influencePoints.red)}`;
}


function checkWinCondition() {
    if (gameState.influencePoints.blue >= gameState.influencePoints.target) {
        alert("BLUE CREW WINS! Newark is ours!");
    } else if (gameState.influencePoints.red >= gameState.influencePoints.target) {
        alert("RED CREW WINS! The streets run red!");
    }
}


function updateZones(delta) {
    // This is the simplified control logic (In a real game, zone.owner would be determined by hero presence)
    gameState.zones.forEach(zone => {
        // For testing, let's assume one side controls the center
        if (zone.id === 'numbers') {
            zone.owner = 'blue'; // Hard-coded for testing UI
        }
        
        if (zone.owner === 'blue') {
            gameState.influencePoints.blue += zone.ipRate * delta;
        } else if (zone.owner === 'red') {
            gameState.influencePoints.red += zone.ipRate * delta;
        }
        
        gameState.influencePoints.blue = Math.min(gameState.influencePoints.blue, gameState.influencePoints.target);
        gameState.influencePoints.red = Math.min(gameState.influencePoints.red, gameState.influencePoints.target);
    });


    updateScoreboard();
}


// --- DRAWING AND GAME LOOP ---


function drawPlayer() {
    ctx.fillStyle = player.isGuarding ? 'yellow' : player.color;
    ctx.beginPath();
    ctx.arc(player.x, player.y, 15, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = 'white';
    ctx.textAlign = 'center';
    ctx.fillText(`Lvl ${player.level}`, player.x, player.y - 20);
}


function drawZones() {
    gameState.zones.forEach(zone => {
        // Color based on owner
        ctx.fillStyle = zone.owner === 'blue' ? 'rgba(52, 152, 219, 0.5)' : 
                        zone.owner === 'red' ? 'rgba(231, 76, 60, 0.5)' : 
                        'rgba(149, 165, 166, 0.5)';
        
        ctx.beginPath();
        ctx.arc(zone.x, zone.y, zone.size, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.fillStyle = 'white';
        ctx.fillText(zone.id.toUpperCase(), zone.x, zone.y);
    });
}


function gameLoop() {
    // Delta time calculation
    const now = Date.now();
    const delta = (now - (gameLoop.lastTime || now)) / 1000;
    gameLoop.lastTime = now;
    
    // 1. Clear the canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // 2. Draw map elements (Simple lanes)
    ctx.strokeStyle = 'gray';
    ctx.lineWidth = 5;
    ctx.beginPath(); ctx.moveTo(0, 100); ctx.lineTo(800, 100); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(0, 500); ctx.lineTo(800, 500); ctx.stroke();


    // 3. Draw the Objective Zones
    drawZones();
    
    // 4. Update Resources (Willpower/Heat)
    updateResources(delta);
    
    // 5. Calculate Zone Control and IP
    updateZones(delta);
    
    // 6. Win Condition Check
    if (Date.now() - (gameLoop.lastWinCheck || 0) > gameState.winCheckInterval * 1000) {
        checkWinCondition();
        gameLoop.lastWinCheck = Date.now();
    }
    
    // 7. Draw the Player
    drawPlayer();


    // 8. Loop the game
    requestAnimationFrame(gameLoop);
}




// --- USER INPUT (Movement and Lawyered Up) ---


window.addEventListener('keydown', (e) => {
    const step = 10;
    // Movement
    if (e.key === 'ArrowRight') player.x += step;
    if (e.key === 'ArrowLeft') player.x -= step;
    if (e.key === 'ArrowUp') player.y -= step;
    if (e.key === 'ArrowDown') player.y += step;
    
    // LAWYERED UP (Guard)
    if (e.key.toUpperCase() === 'G' && !player.isGuarding) {
        player.isGuarding = true;
        console.log("Lawyered Up! Reduced incoming damage.");
    }
});


window.addEventListener('keyup', (e) => {
    if (e.key.toUpperCase() === 'G') {
        player.isGuarding = false;
        console.log("Guard relaxed.");
    }
});




// Start the game
gameLoop.lastTime = Date.now();
gameLoop.lastWinCheck = Date.now();
gameLoop();